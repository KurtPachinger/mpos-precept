/*
MP SELECTORS */

[data-idx],
#css3d {
  /* memory hints */

  &.mp-unset {
    will-change: transform;
  }
  &.mp-poster {
    /* will-change: display; */
  }
  &.mp-native {
    /* pseudo, scroll-position, position, width, height... */
  }

  &.mp-offscreen {
    /*if full-width rules are uncommented*/
    /*will-change: position, width, height;*/
  }
  &#css3d > .mp-block > .mp-block > .mp-block {
    &,
    > * {
      /* css3d and children */
      will-change: transform;
    }
  }
}

.mp-offscreen {
  pointer-events: none;
  > * {
    z-index: 999;
  }
  &.tool {
    bottom: 8rem;
  }
  .jsgif,
  .libgif {
    display: none;
  }
}

.mp-unset {
  background-color: rgba(0, 0, 255, 0.5);
  /* toggle CSS: toSvg, box/css, quirks, offscreen */
  transform: initial !important;
  /* pseudo states */
  &:hover {
    background-color: initial;
  }
  &.mp-offscreen {
    /* full-size box
    position: absolute;
    top: 0;
    right: 100%;
    width: 100%;
    height: 100%;
    > *{width:100%;height:100%;}*/
  }
}

.mp-host {
  position: absolute;
  transform: initial !important;
  /* more */
  rotate: none;
  scale: none;
  zoom: none;
}

.mp-align {
  /* block, margin, transform, animation, left, right
 a, img, span, obj
  */
}

.tool {
  width: 8rem;
  position: fixed;
  bottom: 0;
  right: 0;
  z-index: 3;
}

/* CSS3D: added to user stylesheet to target cloned elements */
/* CSS3D: callout CORS media, such as injected iframes */
#css3d > .mp-block > .mp-block > .mp-block > * {
  border: 0.125rem dotted red;
}

/*
MP INTERFACE */

#mp {
  user-select: none;
  position: fixed;
  &,
  .tool,
  .tool * {
    margin: 0;
    padding: 0;
  }

  #css3d {
    z-index: 1;
    pointer-events: none;

    .mp-block,
    .mp-block > .mp-block > .mp-block > .mp-native {
      pointer-events: none !important;
      > * {
        backface-visibility: hidden;
        /* rgb(0 0 0 / 33.33%) */
        pointer-events: initial;
      }
    }
  }
  &,
  #css3d,
  canvas[data-engine] {
    overflow: hidden;
    /*overflow-y: auto;*/
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }
  #css3d,
  canvas[data-engine] {
    position: absolute;
    cursor: crosshair;
  }
  canvas {
    image-rendering: pixelated;
  }

  #atlas {
    background-color: rgba(255, 255, 255, 0.75);
    overflow: hidden;
    /*overflow-y: auto;*/
    &:hover {
      transform: scale(2);
      transform-origin: bottom right;
    }
    a {
      display: block;
    }
    canvas {
      width: 100%;
      height: auto;
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAIElEQVQYV2Nk+M/QwMDI0MAABYxgGkkQIoAkiBCACgIABm4HhEEa4PgAAAAASUVORK5CYII=');
      background-size: auto 100%;
    }
    #caret {
      /* index and inPolar */
      position: absolute;
      box-sizing: border-box;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0.05em dashed red;
      /*pointer-events: none;*/
      transition: bottom 0.25s, left 0.25s, width 0.25s, height 0.25s, backgroundColor 0.25s;
    }
  }
}

/*
Analogue of raymarch chain:
extract visual hierarchy*/
.march {
  & mp {
    animation-play-state: paused;
  }

  &,
  mp {
    will-change: transform, font-size;
    /* jitter */
    animation-name: march;
    animation-duration: 12s;
    animation-iteration-count: infinite;
    animation-direction: alternate;
    /* structure */
    position: relative;
    pointer-events: none;
    border-radius: 0.25em;
    background-color: rgba(255, 0, 0, 0.5);
    box-shadow: rgba(255, 255, 255, 0.75) 0em 0.125em 0.25em 0.125em inset, rgba(0, 0, 0, 0.25) 0px -0.125em 0.125em 0.125em inset;
    /* progressively larger */
    font-size: 1.25em;
    bottom: 0.125em;

    mp {
      margin-left: 0.5em;
    }
    mp.odd {
      background-color: rgba(0, 0, 255, 0.5);
    }

    &,
    & :after,
    & :before {
      /* structure */
      display: block;
      width: 1em;
      height: 1em;
      text-align: center;
    }

    :after,
    :before {
      /* structure */
      content: '';
      position: absolute;
      font-size: 0.5em;
      animation-delay: 0.25s;
      border-radius: 0.5em 0.5em 0.25em 0.25em;
    }
    :after {
      background-color: rgba(255, 255, 0, 0.25);
      top: 2em;
      left: -0.5em;
    }
    :before {
      background-color: rgba(0, 255, 128, 0.25);
      width: 2em;
    }
  }

  /* jitter */
  > mp {
    animation-delay: 0.125s !important;
    z-index: 2;
    > mp {
      animation-delay: 0.25s !important;
      z-index: 4;
      > mp {
        animation-delay: 0.5s !important;
        z-index: 8;
        mp {
          animation-delay: 0.75s !important;
          z-index: 6;
        }
      }
    }
  }
}

@keyframes march {
  0%,
  20%,
  40%,
  60%,
  80%,
  100% {
    transform: translate(0, 0.5em);
  }
  10%,
  30%,
  50%,
  70%,
  90% {
    transform: translate(0, -0.25em);
  }

  50% {
    transform: translate(0.5em, 0em) rotate(15deg);
    /*left: 0.5em;
    rotate: 15deg;*/
  }
  100% {
    transform: translate(-0.25em, 0em) rotate(-7.5deg);
    /*left: -0.25em;
    rotate: -7.5deg;*/
    font-size: 2.25rem;
  }
}
