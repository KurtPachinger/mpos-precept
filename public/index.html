<!DOCTYPE html>
<html lang="en">
  <head>
    <title>mpos-precept</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Imposter DOM Rects in THREE." />
    <link rel="stylesheet" href="styles.css" />
    <script type="importmap">
      {
        "imports": {
          "three": "//cdn.jsdelivr.net/npm/three@0.175.0/build/three.module.js",
          "three/addons/": "//cdn.jsdelivr.net/npm/three@0.175.0/examples/jsm/"
        }
      }
    </script>
  </head>
  <body class="mp-unstyle">
    <div id="errorMessage"></div>
    <main>
      <!--
        note: xml request does not handle resource load,
        such as model-viewer injected script and size
      -->
    </main>
    <script>
      //
      //
      var tempLoaded
      function insertHTML(url, selector) {
        return fetch(url)
          .then((response) => response.text())
          .then((html) => {
            document.querySelector(selector).innerHTML = html
          })
          .catch((error) => {
            console.error('Error fetching HTML:', error)
          })
      }

      //
      // Await

      const mp = setInterval(() => {
        if (typeof window.mpos !== 'undefined' && document.readyState === 'complete' && !document.hidden) {
          clearInterval(mp)

          // Add content dynamically
          mpos.fnVar('xml', 'xml_suite.html', { selector: 'main' }).finally(() => {
            //
            // Add test of visual hierarchy
            mpos.fnVar('chain', '#overflow', { count: 4, symbol: '-' })
            mpos.fnVar('chain', '#underflow', { count: 4, symbol: '+' })
            // Get depth of element (even before init and add)
            let m = mpos.fnVar('march', '#thread', {})
            // Add test of live depth thresholds
            mpos.fnVar('chain', '#thread', { count: m.slot, symbol: m.slot })

            // Object Preload
            const Object3D = document.createElement('object')
            Object3D.alt = 'Object3D'
            Object3D.classList.add('mp-loader')
            Object3D.data = '//raw.githubusercontent.com/mrdoob/three.js/master/examples/models/json/lightmap/lightmap.json'
            Object3D.style = 'display: block; width: 2em; height: 2em;'

            //
            // Initialize in standalone mode
            mpos.init().then((res) => {
              console.log('mpos:', res)

              //
              // Get depth: m.root + m.slot = opts.depth
              let m = mpos.fnVar('march', '#live', {})
              // Add chain to depth
              const chain = mpos.fnVar('chain', '#live', { count: m.root, symbol: '&#65532;' })
              // Add Object3D to chain: .last from parent, in case zero-length
              chain.parentElement?.querySelector('.last').append(Object3D)

              //
              // Add DOM selector

              mpos.mod.add().then((res) => {
                console.log('mod add:', res)

                //
                // Dynamic object update
                const idxJSON = Object3D.getAttribute('data-idx')
                const rect = mpos.fnVar('find', idxJSON, {})
                // Loader status...?
                console.log('Load status add/obj...?:', rect)
                // Meanwhile flip-y (scale(-1, 0) flickers visibly)
                rect.el.style.transform = 'rotateZ(180deg)'
                rect.el.classList.add('blink')

                //
                // Dynamic content addition
                const element = document.createElement('article')
                element.innerHTML = `<h2>__USE_AFTER_THREE__</h2><div>dynamic<div>content<div>tree</div></div></div>`
                document.querySelector('#live').prepend(element)

                mpos.mod.add(element, { grade: mpos.var.grade }).then((res) => {
                  console.log('mod add grade:', res)
                })
              })

              // init has event listeners...?
            })
          })
        }
      }, 250)

      //
      // User events (native or synthetic)
      document.body.addEventListener(
        'click',
        (e) => {
          const target = e.target
          target.classList.toggle('active')

          if (target.nodeName === 'VIDEO') {
            if (target.paused) target.play()
            else target.pause()
          }
        },
        false
      )
    </script>
    <script src="opencv.js" async></script>
    <!--<script src="//cdn.jsdelivr.net/npm/libgif@0.0.3/libgif.min.js" async></script>-->
  </body>
</html>
